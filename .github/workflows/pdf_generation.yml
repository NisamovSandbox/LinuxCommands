name: Generaci칩n PDF Asciidoctor

on:
  schedule:
    - cron: '0 0 * * 1,5'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar Asciidoctor PDF y dependencias
        run: |
          gem install asciidoctor-pdf --no-document
          gem install rouge --no-document

      - name: Instalar GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librer칤a de traducci칩n
        run: pip install deep-translator

      - name: Crear directorios temporales y de PDFs
        run: |
          mkdir -p tmp_en tmp_de pdf
          # Limpiar directorios previos
          rm -rf tmp_en/* tmp_de/* pdf/*

      - name: Listar y borrar tags
        run: |
          TAGS=$(git tag)
          if [ -z "$TAGS" ]; then
            echo "No hay tags que borrar."
          else
            echo "Borrando tags locales..."
            git tag -d $TAGS || true
            echo "Borrando tags remotos..."
            for TAG in $TAGS; do
              git push origin :refs/tags/$TAG || true
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Borrar releases existentes
        run: |
          set -e
          REPO="${{ github.repository }}"
          PAGE=1
          while true; do
            IDS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" | jq -r '.[].id')
            [ -z "$IDS" ] && break
            for ID in $IDS; do
              [ -z "$ID" ] && continue
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/$ID" || true
            done
            PAGE=$((PAGE + 1))
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generar PDFs ESP, ENG y DE
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)
          
          # Lista espec칤fica de m칩dulos a procesar
          MODULES="document_management fundamentals networking permission_management services software_management storage"
          
          for MODULE in $MODULES; do
            if [ -d "$MODULE" ] && [ -f "$MODULE/index.adoc" ]; then
              echo "=== Procesando m칩dulo: $MODULE ==="
              
              # Espa침ol (original)
              echo "Generando PDF Espa침ol..."
              "$ASCIIDOCTOR" "$MODULE/index.adoc" -o "pdf/ESP_${MODULE}.pdf"
              
              # Ingl칠s
              echo "Traduciendo a ingl칠s..."
              TMP_EN="tmp_en/$MODULE"
              mkdir -p "$TMP_EN"
              cp -r "$MODULE/"* "$TMP_EN/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_EN" en
              
              # Verificar que la traducci칩n funcion칩
              if [ -f "$TMP_EN/index.adoc" ]; then
                echo "Generando PDF Ingl칠s..."
                "$ASCIIDOCTOR" "$TMP_EN/index.adoc" -o "pdf/ENG_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a ingl칠s"
              fi
              
              # Alem치n
              echo "Traduciendo a alem치n..."
              TMP_DE="tmp_de/$MODULE"
              mkdir -p "$TMP_DE"
              cp -r "$MODULE/"* "$TMP_DE/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_DE" de
              
              if [ -f "$TMP_DE/index.adoc" ]; then
                echo "Generando PDF Alem치n..."
                "$ASCIIDOCTOR" "$TMP_DE/index.adoc" -o "pdf/DE_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a alem치n"
              fi
            else
              echo "Saltando $MODULE - no es un m칩dulo v치lido"
            fi
          done

      - name: Crear releases por idioma
        run: |
          echo "Creando releases separados por idioma..."
          
          # Crear release para Espa침ol
          ESP_FILES=$(ls pdf/ESP_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$ESP_FILES" ]; then
            echo "Archivos ESP: $ESP_FILES"
            gh release create ESP $ESP_FILES \
              --title "游댯 Documentaci칩n PDF Espa침ol 游늿" \
              --notes "Documentaci칩n en espa침ol generada autom치ticamente"
          fi
          
          # Crear release para Ingl칠s
          ENG_FILES=$(ls pdf/ENG_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$ENG_FILES" ]; then
            echo "Archivos ENG: $ENG_FILES"
            gh release create ENG $ENG_FILES \
              --title "游댯 Documentaci칩n PDF English 游늿" \
              --notes "Automatically generated English documentation"
          fi
          
          # Crear release para Alem치n
          DE_FILES=$(ls pdf/DE_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$DE_FILES" ]; then
            echo "Archivos DE: $DE_FILES"
            gh release create DE $DE_FILES \
              --title "游댯 Dokumentation PDF Deutsch 游늿" \
              --notes "Automatisch generierte deutsche Dokumentation"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}