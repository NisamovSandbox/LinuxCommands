name: GeneraciÃ³n de DocumentaciÃ³n PDF MultilingÃ¼e

on:
  schedule:
    - cron: '0 0 * * 1' # Ejecutar semanalmente unicamente los lunes
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar fuentes CJK y otras dependencias
        run: |
          sudo apt-get update
          # Instalar fuentes CJK (Chino, JaponÃ©s, Coreano)
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          # Instalar fuentes extra para mejor soporte
          sudo apt-get install -y fonts-noto fonts-noto-extra fonts-dejavu fonts-liberation
          # Verificar instalaciÃ³n
          fc-list | grep -i "noto\|cjk\|japanese\|chinese\|korean" | head -20

      - name: Instalar Asciidoctor PDF y dependencias
        run: |
          gem install asciidoctor-pdf --no-document
          gem install rouge --no-document
          gem install prawn --no-document
          gem install prawn-svg --no-document
          gem install prawn-icon --no-document
          # Instalar tema personalizado para CJK (la gema correcta)
          gem install asciidoctor-pdf-cjk-kai_gen_gothic --no-document
          gem install asciidoctor-multipage --no-document

      - name: Instalar GitHub CLI
        run: sudo apt-get install -y gh

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librerÃ­a de traducciÃ³n
        run: pip install deep-translator

      - name: Crear directorios temporales y de PDFs
        run: |
          # Crear directorios para todos los idiomas incluyendo francÃ©s
          mkdir -p tmp_en tmp_de tmp_pt tmp_ru tmp_zh tmp_ko tmp_ja tmp_fr pdf
          # Limpiar directorios previos
          rm -rf tmp_en/* tmp_de/* tmp_pt/* tmp_ru/* tmp_zh/* tmp_ko/* tmp_ja/* tmp_fr/* pdf/*

      - name: Borrar releases existentes
        run: |
          set -e
          REPO="${{ github.repository }}"
          PAGE=1
          while true; do
            IDS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" | jq -r '.[].id')
            [ -z "$IDS" ] && break
            for ID in $IDS; do
              [ -z "$ID" ] && continue
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/$ID" || true
            done
            PAGE=$((PAGE + 1))
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear tema CJK compatible
        run: |
          cat > cjk-theme.yml << 'EOF'
          extends: default
          
          font:
            catalog:
              KaiGenGothicCN:
                normal: /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc
                bold: /usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc
                italic: /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc
                bold_italic: /usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc
              NotoSans:
                normal: /usr/share/fonts/truetype/noto/NotoSans-Regular.ttf
                bold: /usr/share/fonts/truetype/noto/NotoSans-Bold.ttf
                italic: /usr/share/fonts/truetype/noto/NotoSans-Italic.ttf
                bold_italic: /usr/share/fonts/truetype/noto/NotoSans-BoldItalic.ttf
            
            fallback_fonts:
              - KaiGenGothicCN
              - NotoSans
            
          base:
            font_family: KaiGenGothicCN
            font_size: 10
            line_height: 1.4
            
          heading:
            font_family: KaiGenGothicCN
            font_size: 14
            line_height: 1.3
            
          code:
            font_family: Courier
            font_size: 9
            
          conum:
            font_family: KaiGenGothicCN
            
          footer:
            font_size: 8
            font_color: 666666
          EOF
          
          cat > default-cjk-theme.yml << 'EOF'
          extends: default
          
          font:
            catalog:
              NotoSansCJK:
                normal: /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc
                bold: /usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc
                italic: /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc
                bold_italic: /usr/share/fonts/opentype/noto/NotoSansCJK-Bold.ttc
            
            fallback_fonts:
              - NotoSansCJK
            
          base:
            font_family: NotoSansCJK
            font_color: 333333
            
          heading:
            font_family: NotoSansCJK
            font_color: 000000
            
          literal:
            font_family: Courier
            font_size: 0.9em
            
          code:
            font_family: Courier
            font_size: 0.9em
            font_color: 0066CC
          EOF

      - name: Generar PDFs para todos los idiomas
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)
          
          # FunciÃ³n para generar PDF con configuraciÃ³n apropiada
          generate_pdf() {
            local input_file="$1"
            local output_file="$2"
            local lang="$3"
            
            echo "Generando $output_file para idioma $lang..."
            
            if [[ "$lang" == "zh" || "$lang" == "ko" || "$lang" == "ja" ]]; then
              # Usar configuraciÃ³n CJK con fuentes Noto
              "$ASCIIDOCTOR" "$input_file" \
                -a pdf-theme=default-cjk-theme.yml \
                -a pdf-fontsdir=/usr/share/fonts \
                -a scripts=cjk \
                -a lang="$lang" \
                -a title-font-size=16 \
                -a heading-font-size=14 \
                -a font-size=10 \
                -a line-height=1.4 \
                -o "$output_file"
            else
              # Usar configuraciÃ³n estÃ¡ndar para otros idiomas
              "$ASCIIDOCTOR" "$input_file" \
                -a pdf-theme=default \
                -a pdf-fontsdir=/usr/share/fonts \
                -o "$output_file"
            fi
            
            # Verificar si el PDF se generÃ³ correctamente
            if [ -f "$output_file" ] && [ -s "$output_file" ]; then
              echo "âœ“ PDF generado exitosamente: $output_file"
            else
              echo "âœ— ERROR: No se pudo generar $output_file"
              return 1
            fi
          }
          
          # Lista especÃ­fica de mÃ³dulos a procesar
          MODULES="document_management fundamentals networking permission_management services software_management storage"
          
          # Mapa de idiomas a procesar
          declare -A LANG_MAP=(
            ["en"]="ENG"  # InglÃ©s
            ["de"]="DE"   # AlemÃ¡n
            ["pt"]="PT"   # PortuguÃ©s
            ["ru"]="RU"   # Ruso
            ["fr"]="FR"   # FrancÃ©s (Â¡AÃ‘ADIDO!)
            ["zh"]="ZH"   # Chino
            ["ko"]="KO"   # Coreano
            ["ja"]="JA"   # JaponÃ©s
          )
          
          for MODULE in $MODULES; do
            if [ -d "$MODULE" ] && [ -f "$MODULE/index.adoc" ]; then
              echo "=== Procesando mÃ³dulo: $MODULE ==="
              
              # EspaÃ±ol (original) - Primero
              echo "Generando PDF EspaÃ±ol..."
              generate_pdf "$MODULE/index.adoc" "pdf/ESP_${MODULE}.pdf" "es"
              
              # Traducir y generar para cada idioma
              for lang_code in "${!LANG_MAP[@]}"; do
                lang_prefix="${LANG_MAP[$lang_code]}"
                
                echo "=== Traduciendo a $lang_code ($lang_prefix) ==="
                TMP_DIR="tmp_${lang_code}/$MODULE"
                mkdir -p "$TMP_DIR"
                
                # Copiar estructura original
                if [ -d "$MODULE" ]; then
                  find "$MODULE" -name "*.adoc" -exec cp --parents {} "tmp_${lang_code}/" \; 2>/dev/null || true
                  # TambiÃ©n copiar imÃ¡genes y otros recursos si existen
                  if [ -d "$MODULE/images" ]; then
                    cp -r "$MODULE/images" "tmp_${lang_code}/$MODULE/" 2>/dev/null || true
                  fi
                fi
                
                # Traducir archivos .adoc
                echo "Ejecutando script de traducciÃ³n..."
                python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_DIR" "$lang_code"
                
                # Verificar que se creÃ³ el index.adoc traducido
                if [ -f "$TMP_DIR/index.adoc" ]; then
                  echo "âœ“ TraducciÃ³n completada para $lang_code"
                  
                  # Generar PDF para este idioma
                  echo "Generando PDF $lang_prefix..."
                  generate_pdf "$TMP_DIR/index.adoc" "pdf/${lang_prefix}_${MODULE}.pdf" "$lang_code"
                  
                  # Verificar el PDF generado
                  if [ -f "pdf/${lang_prefix}_${MODULE}.pdf" ]; then
                    PDF_SIZE=$(stat -c%s "pdf/${lang_prefix}_${MODULE}.pdf" 2>/dev/null || stat -f%z "pdf/${lang_prefix}_${MODULE}.pdf")
                    echo "âœ“ PDF $lang_prefix generado: $(($PDF_SIZE/1024)) KB"
                  fi
                else
                  echo "âœ— ERROR: No se pudo traducir $MODULE a $lang_code"
                  echo "  El archivo $TMP_DIR/index.adoc no existe"
                fi
                
                # PequeÃ±a pausa entre idiomas para evitar rate limiting
                echo "Pausando 2 segundos..."
                sleep 2
              done
              
              echo "âœ“ MÃ³dulo $MODULE completado"
              echo ""
              
            else
              echo "âœ— Saltando $MODULE - no es un mÃ³dulo vÃ¡lido"
            fi
          done

          echo "=== Resumen de mÃ³dulos procesados ==="
          for MODULE in $MODULES; do
            if [ -d "$MODULE" ]; then
              echo "MÃ³dulo: $MODULE"
              for lang_prefix in ESP ENG DE PT RU FR ZH KO JA; do
                PDF_FILE="pdf/${lang_prefix}_${MODULE}.pdf"
                if [ -f "$PDF_FILE" ]; then
                  PDF_SIZE=$(stat -c%s "$PDF_FILE" 2>/dev/null || stat -f%z "$PDF_FILE")
                  echo "  âœ“ $lang_prefix: $(($PDF_SIZE/1024)) KB"
                fi
              done
            fi
          done

      - name: Verificar PDFs generados
        run: |
          echo "=== Verificando PDFs generados ==="
          ls -la pdf/
          echo ""
          echo "=== Total de PDFs generados ==="
          find pdf -name "*.pdf" -type f | wc -l
          echo ""
          echo "=== Lista de PDFs por idioma ==="
          for lang in ESP ENG DE PT RU FR ZH KO JA; do
            COUNT=$(find pdf -name "${lang}_*.pdf" -type f 2>/dev/null | wc -l)
            echo "  $lang: $COUNT archivos"
          done
          echo ""
          echo "=== TamaÃ±o de PDFs ==="
          du -h pdf/*.pdf | sort -h
          echo ""
          echo "=== Verificando fuentes disponibles ==="
          fc-list | grep -i "noto.*cjk" | head -5

      - name: Crear releases por idioma
        run: |
          echo "Creando releases separados por idioma..."
          
          # URLs de imÃ¡genes (incluyendo francÃ©s)
          ESPImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ESP.png"
          ENGImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ENG.png"
          DEImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_DE.png"
          PTImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_PT.png"
          RUImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_RU.png"
          FRImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_FR.png"
          ZHImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ZH.png"
          KOImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_KO.png"
          JAImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_JA.png"

          # FunciÃ³n para crear release
          create_release() {
            local lang_code="$1"
            local title="$2"
            local img_url="$3"
            
            # Buscar archivos para este idioma
            FILES=$(find pdf -name "${lang_code}_*.pdf" -type f 2>/dev/null | sort)
            
            if [ -n "$FILES" ] && [ ! -z "$(echo "$FILES" | tr -d '[:space:]')" ]; then
              echo "=== Creando release para $lang_code ==="
              echo "Archivos encontrados:"
              echo "$FILES"
              
              # Verificar que los archivos existan y no estÃ©n vacÃ­os
              VALID_FILES=""
              for file in $FILES; do
                if [ -f "$file" ] && [ -s "$file" ]; then
                  FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
                  if [ $FILE_SIZE -gt 1000 ]; then  # Al menos 1KB
                    VALID_FILES="$VALID_FILES $file"
                    echo "  âœ“ $(basename "$file") - $(($FILE_SIZE/1024)) KB"
                  else
                    echo "  âœ— $(basename "$file") - DEMASIADO PEQUEÃ‘O ($FILE_SIZE bytes)"
                  fi
                else
                  echo "  âœ— $(basename "$file") - NO EXISTE O ESTÃ VACÃO"
                fi
              done
              
              if [ -n "$VALID_FILES" ]; then
                echo "Creando release $lang_code con $(echo $VALID_FILES | wc -w) archivos..."
                
                # Crear release con gh CLI
                gh release create "$lang_code" $VALID_FILES \
                  --title "$title" \
                  --notes "![DocumentaciÃ³n $lang_code]($img_url)
                  
                  ### PDFs disponibles:
                  $(for file in $VALID_FILES; do 
                    FILE_SIZE=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file")
                    echo "- **$(basename "$file")** - $(($FILE_SIZE/1024)) KB"; 
                  done)
                  
                  ### Fuentes utilizadas:
                  - Noto Sans (todos los idiomas)
                  - Noto Sans CJK (idiomas asiÃ¡ticos)
                  - Courier (cÃ³digo fuente)
                  
                  ### Generado automÃ¡ticamente:
                  - Fecha: $(date '+%Y-%m-%d')
                  - Hora: $(date '+%H:%M:%S')
                  - Repositorio: ${{ github.repository }}
                  
                  ---
                  *Esta documentaciÃ³n se genera automÃ¡ticamente cada semana*" \
                  --verify-tag
                
                echo "âœ“ Release creada para $lang_code"
              else
                echo "âœ— No hay archivos vÃ¡lidos para crear release $lang_code"
              fi
            else
              echo "âœ— No se encontraron archivos PDF para $lang_code"
            fi
          }
          
          # Crear releases en orden alfabÃ©tico
          create_release "DE" "ğŸ”µ PDF DOKUMENTATION ğŸ“• (Deutsch)" "$DEImg"
          create_release "ENG" "ğŸ”µ PDF DOCUMENTATION ğŸ“• (English)" "$ENGImg"
          create_release "ESP" "ğŸ”µ DOCUMENTACIÃ“N PDF ğŸ“• (EspaÃ±ol)" "$ESPImg"
          create_release "FR" "ğŸ”µ DOCUMENTATION PDF ğŸ“• (FranÃ§ais)" "$FRImg"
          create_release "JA" "ğŸ”µ PDF ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ğŸ“• (æ—¥æœ¬èª)" "$JAImg"
          create_release "KO" "ğŸ”µ PDF ë¬¸ì„œ ğŸ“• (í•œêµ­ì–´)" "$KOImg"
          create_release "PT" "ğŸ”µ DOCUMENTAÃ‡ÃƒO EM PDF ğŸ“• (PortuguÃªs)" "$PTImg"
          create_release "RU" "ğŸ”µ PDF Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ¦Ğ˜Ğ¯ ğŸ“• (Ğ ÑƒÑÑĞºĞ¸Ğ¹)" "$RUImg"
          create_release "ZH" "ğŸ”µ PDF æ–‡æ¡£ ğŸ“• (ä¸­æ–‡)" "$ZHImg"
          
          echo "Todas las releases creadas"
          gh release list --limit 20
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Limpiar directorios temporales
        if: always()
        run: |
          echo "Limpiando directorios temporales..."
          rm -rf tmp_en tmp_de tmp_pt tmp_ru tmp_fr tmp_zh tmp_ko tmp_ja
          echo "âœ“ Limpieza completada"