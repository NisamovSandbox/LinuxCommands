name: GeneraciÃ³n de DocumentaciÃ³n PDF MultilingÃ¼e

# El proceso puede tardar entre 2 y 3 horas
# Segun el repositorio crezca, esta cifra irÃ¡ en aumento.
# Es posible ejecutar este script manualmente, pero no se recomienda debido al tiempo que toma.

on:
  schedule:
    - cron: '0 0 * * 1' # Ejecutar semanalmente unicamente los lunes
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar fuentes CJK y otras dependencias
        run: |
          sudo apt-get update
          # Instalar fuentes CJK (Chino, JaponÃ©s, Coreano)
          sudo apt-get install -y fonts-noto-cjk fonts-noto-cjk-extra
          # Instalar fuentes extra para mejor soporte
          sudo apt-get install -y fonts-noto fonts-noto-extra fonts-dejavu fonts-liberation
          # Verificar instalaciÃ³n
          fc-list | grep -i "noto\|cjk\|japanese\|chinese\|korean" | head -20

      - name: Instalar Asciidoctor PDF y dependencias
        run: |
          gem install asciidoctor-pdf --no-document
          gem install rouge --no-document
          gem install prawn --no-document
          gem install prawn-svg --no-document
          gem install prawn-icon --no-document
          # Instalar tema personalizado para CJK
          gem install asciidoctor-pdf-cjk --no-document

      - name: Instalar GitHub CLI
        run: sudo apt-get install -y gh

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librerÃ­a de traducciÃ³n
        run: pip install deep-translator

      - name: Crear directorios temporales y de PDFs
        run: |
          mkdir -p tmp_en tmp_de tmp_pt tmp_ru tmp_zh tmp_ko tmp_ja pdf
          # Limpiar directorios previos
          rm -rf tmp_en/* tmp_de/* tmp_pt/* tmp_ru/* tmp_zh/* tmp_ko/* tmp_ja/* pdf/*

      - name: Listar y borrar tags
        run: |
          TAGS=$(git tag)
          if [ -z "$TAGS" ]; then
            echo "No hay tags que borrar."
          else
            echo "Borrando tags locales..."
            git tag -d $TAGS || true
            echo "Borrando tags remotos..."
            for TAG in $TAGS; do
              git push origin :refs/tags/$TAG || true
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Borrar releases existentes
        run: |
          set -e
          REPO="${{ github.repository }}"
          PAGE=1
          while true; do
            IDS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" | jq -r '.[].id')
            [ -z "$IDS" ] && break
            for ID in $IDS; do
              [ -z "$ID" ] && continue
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/$ID" || true
            done
            PAGE=$((PAGE + 1))
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear tema simple para CJK (opcional)
        run: |
          cat > default-cjk.yml << 'EOF'
          extends: default
          font:
            catalog:
              Noto Sans:
                normal: /usr/share/fonts/truetype/noto/NotoSans-Regular.ttf
                bold: /usr/share/fonts/truetype/noto/NotoSans-Bold.ttf
                italic: /usr/share/fonts/truetype/noto/NotoSans-Italic.ttf
                bold_italic: /usr/share/fonts/truetype/noto/NotoSans-BoldItalic.ttf
            fallback:
              - Noto Sans
          EOF

      - name: Generar PDFs ESP, ENG, DE, PT, RU, ZH, KO y JA
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)
          
          # Lista especÃ­fica de mÃ³dulos a procesar
          MODULES="document_management fundamentals networking permission_management services software_management storage"
          
          for MODULE in $MODULES; do
            if [ -d "$MODULE" ] && [ -f "$MODULE/index.adoc" ]; then
              echo "=== Procesando mÃ³dulo: $MODULE ==="
              
              # EspaÃ±ol (original)
              echo "Generando PDF EspaÃ±ol..."
              "$ASCIIDOCTOR" "$MODULE/index.adoc" \
                -a pdf-theme=default \
                -a pdf-fontsdir=/usr/share/fonts \
                -o "pdf/ESP_${MODULE}.pdf"
              
              # InglÃ©s
              echo "Traduciendo a inglÃ©s..."
              TMP_EN="tmp_en/$MODULE"
              mkdir -p "$TMP_EN"
              cp -r "$MODULE/"* "$TMP_EN/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_EN" en
              
              if [ -f "$TMP_EN/index.adoc" ]; then
                echo "Generando PDF InglÃ©s..."
                "$ASCIIDOCTOR" "$TMP_EN/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -o "pdf/ENG_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a inglÃ©s"
              fi
              
              # AlemÃ¡n
              echo "Traduciendo a alemÃ¡n..."
              TMP_DE="tmp_de/$MODULE"
              mkdir -p "$TMP_DE"
              cp -r "$MODULE/"* "$TMP_DE/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_DE" de
              
              if [ -f "$TMP_DE/index.adoc" ]; then
                echo "Generando PDF AlemÃ¡n..."
                "$ASCIIDOCTOR" "$TMP_DE/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -o "pdf/DE_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a alemÃ¡n"
              fi
              
              # PortuguÃ©s
              echo "Traduciendo a portuguÃ©s..."
              TMP_PT="tmp_pt/$MODULE"
              mkdir -p "$TMP_PT"
              cp -r "$MODULE/"* "$TMP_PT/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_PT" pt
              
              if [ -f "$TMP_PT/index.adoc" ]; then
                echo "Generando PDF PortuguÃ©s..."
                "$ASCIIDOCTOR" "$TMP_PT/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -o "pdf/PT_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a portuguÃ©s"
              fi
              
              # Ruso
              echo "Traduciendo a ruso..."
              TMP_RU="tmp_ru/$MODULE"
              mkdir -p "$TMP_RU"
              cp -r "$MODULE/"* "$TMP_RU/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_RU" ru
              
              if [ -f "$TMP_RU/index.adoc" ]; then
                echo "Generando PDF Ruso..."
                "$ASCIIDOCTOR" "$TMP_RU/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -o "pdf/RU_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a ruso"
              fi
              
              # Chino (con tema por defecto y fuentes CJK)
              echo "Traduciendo a chino..."
              TMP_ZH="tmp_zh/$MODULE"
              mkdir -p "$TMP_ZH"
              cp -r "$MODULE/"* "$TMP_ZH/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_ZH" zh
              
              if [ -f "$TMP_ZH/index.adoc" ]; then
                echo "Generando PDF Chino con tema por defecto..."
                "$ASCIIDOCTOR" "$TMP_ZH/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -a scripts=cjk \
                  -a lang=zh \
                  -o "pdf/ZH_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a chino"
              fi
              
              # Coreano (con tema por defecto y fuentes CJK)
              echo "Traduciendo a coreano..."
              TMP_KO="tmp_ko/$MODULE"
              mkdir -p "$TMP_KO"
              cp -r "$MODULE/"* "$TMP_KO/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_KO" ko
              
              if [ -f "$TMP_KO/index.adoc" ]; then
                echo "Generando PDF Coreano con tema por defecto..."
                "$ASCIIDOCTOR" "$TMP_KO/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -a scripts=cjk \
                  -a lang=ko \
                  -o "pdf/KO_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a coreano"
              fi
              
              # JaponÃ©s (con tema por defecto y fuentes CJK)
              echo "Traduciendo a japonÃ©s..."
              TMP_JA="tmp_ja/$MODULE"
              mkdir -p "$TMP_JA"
              cp -r "$MODULE/"* "$TMP_JA/" 2>/dev/null || true
              python3 .github/scripts/translate_adoc.py "$MODULE" "$TMP_JA" ja
              
              if [ -f "$TMP_JA/index.adoc" ]; then
                echo "Generando PDF JaponÃ©s con tema por defecto..."
                "$ASCIIDOCTOR" "$TMP_JA/index.adoc" \
                  -a pdf-theme=default \
                  -a pdf-fontsdir=/usr/share/fonts \
                  -a scripts=cjk \
                  -a lang=ja \
                  -o "pdf/JA_${MODULE}.pdf"
              else
                echo "ERROR: No se pudo traducir $MODULE a japonÃ©s"
              fi
            else
              echo "Saltando $MODULE - no es un mÃ³dulo vÃ¡lido"
            fi
          done

      - name: Verificar PDFs generados
        run: |
          echo "=== Verificando PDFs generados ==="
          ls -la pdf/
          echo ""
          echo "=== Verificando fuentes instaladas ==="
          fc-list | grep -i "noto\|cjk" | sort | uniq | head -30
          echo ""
          echo "=== TamaÃ±o de PDFs ==="
          du -h pdf/*.pdf

      - name: Crear releases por idioma
        run: |
          echo "Creando releases separados por idioma..."
          ESPImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ESP.png"
          ENGImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ENG.png"
          DEImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_DE.png"
          PTImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_PT.png"
          RUImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_RU.png"
          FRImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_FR.png"
          ZHImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_ZH.png"
          KOImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_KO.png"
          JAImg="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_JA.png"

          # Crear release para JaponÃ©s
          JA_FILES=$(ls pdf/JA_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$JA_FILES" ]; then
            echo "Archivos JA: $JA_FILES"
            gh release create JA $JA_FILES \
              --title "ðŸ”µ PDF ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ ðŸ“• (Con soporte de fuentes CJK)" \
              --notes "![DocumentaciÃ³n JaponÃ©s]($JAImg)"
          fi
          
          # Crear release para Coreano
          KO_FILES=$(ls pdf/KO_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$KO_FILES" ]; then
            echo "Archivos KO: $KO_FILES"
            gh release create KO $KO_FILES \
              --title "ðŸ”µ PDF ë¬¸ì„œ ðŸ“• (Con soporte de fuentes CJK)" \
              --notes "![DocumentaciÃ³n Coreano]($KOImg)"
          fi
          
          # Crear release para Chino
          ZH_FILES=$(ls pdf/ZH_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$ZH_FILES" ]; then
            echo "Archivos ZH: $ZH_FILES"
            gh release create ZH $ZH_FILES \
              --title "ðŸ”µ PDF æ–‡æ¡£ ðŸ“• (Con soporte de fuentes CJK)" \
              --notes "![DocumentaciÃ³n Chino]($ZHImg)"
          fi

          # Crear release para FrancÃ©s
          FR_FILES=$(ls pdf/FR_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$FR_FILES" ]; then
            echo "Archivos FR: $FR_FILES"
            gh release create FR $FR_FILES \
              --title "ðŸ”µ DOCUMENTATION PDF ðŸ“•" \
              --notes "![DocumentaciÃ³n FrancÃ©s]($FRImg)"
          fi
          
          # Crear release para Ruso
          RU_FILES=$(ls pdf/RU_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$RU_FILES" ]; then
            echo "Archivos RU: $RU_FILES"
            gh release create RU $RU_FILES \
              --title "ðŸ”µ PDF Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐÐ¦Ð˜Ð¯ ðŸ“•" \
              --notes "![DocumentaciÃ³n Ruso]($RUImg)"
          fi
          
          # Crear release para PortuguÃ©s
          PT_FILES=$(ls pdf/PT_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$PT_FILES" ]; then
            echo "Archivos PT: $PT_FILES"
            gh release create PT $PT_FILES \
              --title "ðŸ”µ DOCUMENTAÃ‡ÃƒO EM PDF ðŸ“•" \
              --notes "![DocumentaÃ§Ã£o PortuguÃªs]($PTImg)"
          fi
          
          # Crear release para InglÃ©s
          ENG_FILES=$(ls pdf/ENG_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$ENG_FILES" ]; then
            echo "Archivos ENG: $ENG_FILES"
            gh release create ENG $ENG_FILES \
              --title "ðŸ”µ PDF DOCUMENTATION ðŸ“•" \
              --notes "![DocumentaciÃ³n InglÃ©s]($ENGImg)"
          fi
          
          # Crear release para AlemÃ¡n
          DE_FILES=$(ls pdf/DE_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$DE_FILES" ]; then
            echo "Archivos DE: $DE_FILES"
            gh release create DE $DE_FILES \
              --title "ðŸ”µ PDF DOKUMENTATION ðŸ“•" \
              --notes "![DocumentaciÃ³n AlemÃ¡n]($DEImg)"
          fi

          # Crear release para EspaÃ±ol
          ESP_FILES=$(ls pdf/ESP_*.pdf 2>/dev/null | tr '\n' ' ')
          if [ -n "$ESP_FILES" ]; then
            echo "Archivos ESP: $ESP_FILES"
            gh release create ESP $ESP_FILES \
              --title "ðŸ”µ DOCUMENTACIÃ“N PDF ðŸ“•" \
              --notes "![DocumentaciÃ³n EspaÃ±ol]($ESPImg)"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}