=== Módulo GeoIP2
// Documentado por Andrés Ruslan Abadías Otal (Nisamov)

Bloquear países en el servidor web::

[source,bash]
----
sudo apt update && sudo apt upgrade -y
sudo apt install libmaxminddb0 libmaxminddb-dev mmdb-bin nginx-module-geoip2 -y
----

Verificar existencia del módulo GeoIP2::

[source,bash]
----
ls /usr/lib/nginx/modules/ | grep geoip
# Debe devolver ngx_http_geoip2_module.so
----

Crear cuenta en MaxMind, generar una licencia y descargar la base de datos `GeoLite2-Country.mmdb`.

Mover la base de datos a su ubicación::

[source,bash]
----
sudo mkdir -p /etc/nginx/geoip
sudo cp GeoLite2-Country.mmdb /etc/nginx/geoip/
sudo chmod 644 /etc/nginx/geoip/GeoLite2-Country.mmdb
----

Aplicar módulo GeoIP en la configuración de NGINX::

[source,bash]
----
sudo nano /etc/nginx/nginx.conf
# Agregar antes de events{}
load_module modules/ngx_http_geoip2_module.so;
----

Configurar GeoIP2 dentro de `http {}` en `/etc/nginx/nginx.conf`::

[source,bash]
----
http {
    geoip2 /etc/nginx/geoip/GeoLite2-Country.mmdb {
        $geoip2_country_code source=$remote_addr country iso_code;
    }
    map $geoip2_country_code $allowed_country {
        default yes;
        US no;
        MX no;
        AR no;
        CO no;
        CL no;
        PE no;
        BR no;
        VE no;
        EC no;
        BO no;
        PY no;
        UY no;
        DO no;
        CU no;
        GT no;
        HN no;
        NI no;
        SV no;
        CR no;
        PA no;
    }
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}
----

Editar la configuración de la página::

[source,bash]
----
sudo nano /etc/nginx/sites-available/mipagina.es
----

Agregar reglas de bloqueo dentro de `server {}`::

[source,bash]
----
server {
    listen 80;
    server_name mipagina.duckdns.org www.mipagina.duckdns.org;
    if ($allowed_country = no) {
        return 403;
    }
    root /var/www/mipagina.es;
    index index.html index.htm;
    location / {
        try_files $uri $uri/ =404;
    }
}
----

Recargar NGINX y verificar la configuración::

[source,bash]
----
sudo nginx -t
sudo systemctl reload nginx
----

